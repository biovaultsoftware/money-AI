<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b141a" />
  <meta name="color-scheme" content="dark light" />
  <title>Money AI</title>

  <!-- PWA manifest injected at runtime (single-file) -->
  <link id="manifestLink" rel="manifest" href="" />

  <style>
    :root{
      --bg:#0b141a;
      --panel:#111b21;
      --panel2:#1f2c34;
      --text:#e9edef;
      --muted:#8696a0;
      --green:#00a884;
      --gold:#caa64a;
      --danger:#ef4444;
      --bubble-in:#005c4b;
      --bubble-out:#202c33;
      --line:rgba(255,255,255,.08);
      --shadow: 0 12px 28px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    [data-theme="light"]{
      --bg:#f0f2f5;
      --panel:#ffffff;
      --panel2:#f7f8fa;
      --text:#111827;
      --muted:#6b7280;
      --green:#128c7e;
      --gold:#b0892f;
      --danger:#dc2626;
      --bubble-in:#dcf8c6;
      --bubble-out:#ffffff;
      --line:rgba(0,0,0,.08);
      --shadow: 0 12px 28px rgba(0,0,0,.12);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      background:var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }
    button,input,textarea{font-family:inherit}
    a{color:inherit}

    /* App shell */
    .app{
      height:100%;
      display:flex;
      flex-direction:column;
      max-width: 1100px;
      margin: 0 auto;
      background: radial-gradient(1200px 800px at 40% -10%, rgba(202,166,74,.10), transparent 55%),
                  radial-gradient(900px 700px at 120% 20%, rgba(0,168,132,.10), transparent 50%),
                  var(--bg);
    }

    .topbar{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,0));
      position:sticky;
      top:0;
      z-index:5;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800; letter-spacing:.2px;
    }
    .brand .dot{
      width:10px;height:10px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #7fffd4, var(--green));
      box-shadow: 0 0 0 3px rgba(0,168,132,.15);
    }
    .top-actions{display:flex; gap:8px; align-items:center}
    .iconbtn{
      width:38px;height:38px;border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease;
    }
    .iconbtn:active{transform:scale(.98)}
    .iconbtn:hover{background: rgba(255,255,255,.06)}
    .iconbtn svg{width:18px;height:18px;opacity:.9}

    .content{
      flex:1;
      display:flex;
      min-height:0;
    }

    /* Desktop split view */
    .leftPane{
      width: 380px;
      border-right:1px solid var(--line);
      background: color-mix(in oklab, var(--panel), transparent 35%);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .rightPane{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
      background: color-mix(in oklab, var(--panel), transparent 55%);
    }
    @media (max-width: 840px){
      .content{display:block}
      .leftPane,.rightPane{width:100%;border-right:none}
      .rightPane{display:none}
      body[data-route="chat"] .leftPane{display:none}
      body[data-route="chat"] .rightPane{display:flex}
      body[data-route="reels"] .leftPane{display:none}
      body[data-route="reels"] .rightPane{display:flex}
      body[data-route="settings"] .leftPane{display:none}
      body[data-route="settings"] .rightPane{display:flex}
    }

    /* Tabs (mobile bottom) */
    .tabs{
      height:56px;
      border-top:1px solid var(--line);
      display:none;
      background: color-mix(in oklab, var(--panel), transparent 10%);
      position:sticky;
      bottom:0;
      z-index:5;
      backdrop-filter: blur(10px);
    }
    @media (max-width: 840px){ .tabs{display:flex} }
    .tab{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      position:relative;
    }
    .tab.active{color:var(--text)}
    .tab svg{width:18px;height:18px;opacity:.9}
    .tab .pill{
      position:absolute;
      top:8px;
      right:calc(50% - 18px);
      min-width:16px;height:16px;
      padding:0 5px;
      border-radius:999px;
      background:var(--green);
      color:white;
      font-size:11px;
      display:none;
      align-items:center;
      justify-content:center;
    }
    .tab.hasBadge .pill{display:inline-flex}

    /* Search + stories strip */
    .searchRow{
      padding:10px 12px;
    }
    .search{
      display:flex; align-items:center; gap:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .search svg{width:16px;height:16px;opacity:.8}
    .search input{
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .storiesStrip{
      display:flex;
      gap:12px;
      padding: 8px 12px 12px;
      overflow:auto;
      scrollbar-width:none;
    }
    .storiesStrip::-webkit-scrollbar{display:none}
    .storyChip{
      width:56px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
      cursor:pointer;
      user-select:none;
    }
    .avatarRing{
      width:54px;height:54px;border-radius:50%;
      display:grid;place-items:center;
      padding:2px;
      background: conic-gradient(from 90deg, var(--gold), var(--green), var(--gold));
      box-shadow: 0 10px 20px rgba(0,0,0,.18);
    }
    .avatarRing.read{
      background: conic-gradient(from 90deg, rgba(134,150,160,.55), rgba(134,150,160,.25));
      opacity:.85;
    }
    .avatar{
      width:100%;height:100%;
      border-radius:50%;
      overflow:hidden;
      border:2px solid var(--panel);
      background: rgba(255,255,255,.06);
      display:grid;
      place-items:center;
    }
    .storyChip .name{
      font-size:12px;
      color:var(--muted);
      width:56px;
      text-align:center;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* Chat list */
    .list{
      flex:1;
      overflow:auto;
      min-height:0;
    }
    .chatRow{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      border-top:1px solid transparent;
      border-bottom:1px solid var(--line);
      cursor:pointer;
      user-select:none;
      transition: background .15s ease;
      position:relative;
    }
    .chatRow:hover{background: rgba(255,255,255,.03)}
    .chatRow.active{background: rgba(0,168,132,.10)}
    .chatRow .meta{flex:1; min-width:0}
    .chatRow .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .chatRow .title{
      font-weight:700;
      font-size:15px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .chatRow .time{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .chatRow .bottom{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:2px;
    }
    .chatRow .preview{
      font-size:13px;
      color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width: 245px;
    }
    .badge{
      min-width:18px;height:18px;
      padding:0 6px;
      border-radius:999px;
      background:var(--green);
      color:white;
      font-size:12px;
      display:none;
      align-items:center;
      justify-content:center;
      font-weight:700;
    }
    .chatRow.unread .badge{display:inline-flex}
    .pin{
      position:absolute;
      left: 6px;
      top: 10px;
      width:18px;height:18px;
      display:none;
      place-items:center;
      opacity:.9;
    }
    .chatRow.pinned .pin{display:grid}
    .pin svg{width:14px;height:14px}

    /* Context menu */
    .menu{
      position:fixed;
      inset:auto auto 20px 20px;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
      z-index:50;
      min-width: 220px;
      display:none;
    }
    .menu.open{display:block}
    .menu .mi{
      padding:12px 12px;
      display:flex; align-items:center; gap:10px;
      cursor:pointer;
      border-bottom:1px solid var(--line);
      user-select:none;
    }
    .menu .mi:last-child{border-bottom:none}
    .menu .mi:hover{background: rgba(255,255,255,.04)}
    .menu .mi svg{width:16px;height:16px;opacity:.9}
    .menu .mi.danger{color: color-mix(in oklab, var(--danger), var(--text) 30%)}

    /* Chat view */
    .chatHeader{
      height:56px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:0 12px;
      border-bottom:1px solid var(--line);
      background: color-mix(in oklab, var(--panel), transparent 15%);
      position:sticky;
      top:56px;
      z-index:4;
      backdrop-filter: blur(10px);
    }
    @media (max-width: 840px){
      .chatHeader{top:0}
      .topbar{display:none}
      .app{max-width:none}
    }
    .backBtn{display:none}
    @media (max-width: 840px){ .backBtn{display:inline-flex} }
    .chatHeader .who{
      display:flex; align-items:center; gap:10px; min-width:0; flex:1;
    }
    .chatHeader .who .whoName{font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .chatHeader .who .status{font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .chatHeader .hdrActions{display:flex; gap:8px}
    .thread{
      flex:1;
      overflow:auto;
      padding: 14px 12px 10px;
      min-height:0;
      background:
        radial-gradient(1100px 700px at 20% 0%, rgba(202,166,74,.09), transparent 55%),
        radial-gradient(900px 600px at 90% 25%, rgba(0,168,132,.09), transparent 52%),
        linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,0));
    }
    [data-theme="light"] .thread{
      background:
        radial-gradient(1100px 700px at 20% 0%, rgba(176,137,47,.11), transparent 55%),
        radial-gradient(900px 600px at 90% 25%, rgba(18,140,126,.10), transparent 52%),
        linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,0));
    }
    .msgRow{
      display:flex;
      margin: 6px 0;
    }
    .msgRow.in{justify-content:flex-start}
    .msgRow.out{justify-content:flex-end}
    .bubble{
      max-width: min(680px, 86%);
      border-radius: 18px;
      padding: 10px 12px;
      line-height: 1.35;
      font-size: 14px;
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      border:1px solid var(--line);
      position:relative;
      overflow:hidden;
    }
    .msgRow.in .bubble{
      background: color-mix(in oklab, var(--bubble-out), transparent 0%);
    }
    .msgRow.out .bubble{
      background: color-mix(in oklab, var(--bubble-in), transparent 0%);
      border-color: color-mix(in oklab, var(--bubble-in), white 14%);
    }
    [data-theme="light"] .msgRow.out .bubble{
      border-color: rgba(0,0,0,.06);
    }
    .bubble .meta{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:6px;
      color: color-mix(in oklab, var(--muted), var(--text) 15%);
      font-size:11px;
      user-select:none;
    }
    .bubble .tag{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px;
      color: var(--muted);
      margin-bottom:6px;
    }
    .bubble .tag .dot{
      width:6px;height:6px;border-radius:50%;
      background: var(--gold);
      opacity:.9;
    }
    .bubble .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .chipBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:8px 10px;
      border-radius: 999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      transition: background .15s ease, transform .08s ease;
    }
    .chipBtn:hover{background: rgba(255,255,255,.06)}
    .chipBtn:active{transform: scale(.98)}
    .composer{
      border-top:1px solid var(--line);
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      background: color-mix(in oklab, var(--panel), transparent 8%);
      display:flex;
      align-items:flex-end;
      gap:10px;
    }
    .composer .quick{
      display:flex; gap:8px;
    }
    .composer .inputWrap{
      flex:1;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding:8px 10px;
      display:flex;
      gap:8px;
      align-items:flex-end;
    }
    textarea{
      flex:1;
      border:none;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:14px;
      line-height:1.35;
      resize:none;
      max-height: 120px;
      min-height: 22px;
    }
    .sendBtn{
      width:44px;height:44px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: var(--green);
      color:white;
      cursor:pointer;
      display:grid;
      place-items:center;
      box-shadow: 0 12px 20px rgba(0,168,132,.20);
      transition: transform .08s ease;
    }
    .sendBtn:active{transform:scale(.98)}
    .sendBtn svg{width:18px;height:18px}

    /* Reels */
    .reelsWrap{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .reelsHeader{
      height:56px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 12px;
      border-bottom:1px solid var(--line);
      background: color-mix(in oklab, var(--panel), transparent 15%);
      position:sticky;
      top:56px;
      z-index:4;
      backdrop-filter: blur(10px);
    }
    @media (max-width: 840px){ .reelsHeader{top:0} }
    .reelsGrid{
      padding:12px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:12px;
      overflow:auto;
      min-height:0;
    }
    @media (min-width: 900px){
      .reelsGrid{grid-template-columns: repeat(3, minmax(0, 1fr))}
    }
    .reelCard{
      background: color-mix(in oklab, var(--panel), transparent 0%);
      border:1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      box-shadow: 0 10px 22px rgba(0,0,0,.16);
      cursor:pointer;
      user-select:none;
      display:flex;
      flex-direction:column;
      min-height: 210px;
    }
    .reelThumb{
      flex:1;
      position:relative;
      background:
        radial-gradient(600px 320px at 30% 20%, rgba(202,166,74,.25), transparent 60%),
        radial-gradient(520px 340px at 80% 70%, rgba(0,168,132,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.18));
      display:flex;
      align-items:flex-end;
      padding:12px;
    }
    .reelThumb .overlay{
      width:100%;
      background: rgba(0,0,0,.36);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding:10px;
      backdrop-filter: blur(10px);
    }
    [data-theme="light"] .reelThumb .overlay{
      background: rgba(255,255,255,.55);
      border:1px solid rgba(0,0,0,.08);
    }
    .reelThumb .line1{font-weight:900; font-size:14px}
    .reelThumb .line2{font-size:13px; color: color-mix(in oklab, var(--muted), var(--text) 20%); margin-top:4px}
    .reelMeta{
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border-top:1px solid var(--line);
    }
    .reelMeta .left{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .reelMeta .who{font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .reelMeta .date{font-size:12px; color:var(--muted)}
    .playPill{
      padding:6px 10px;
      border-radius:999px;
      background: rgba(0,168,132,.14);
      border:1px solid rgba(0,168,132,.25);
      color: color-mix(in oklab, var(--text), white 10%);
      font-size:12px;
      font-weight:800;
    }

    /* Reel viewer */
    .viewer{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.78);
      z-index:60;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .viewer.open{display:flex}
    .viewerCard{
      width:min(520px, 100%);
      border-radius: 22px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: color-mix(in oklab, var(--panel), black 10%);
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    .viewerTop{
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .progress{
      height:3px;
      background: rgba(255,255,255,.12);
      border-radius:999px;
      overflow:hidden;
      margin:8px 12px 0;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--gold), var(--green));
    }
    .viewerBody{
      padding:12px;
      min-height: 250px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:10px;
      background:
        radial-gradient(700px 400px at 35% 20%, rgba(202,166,74,.18), transparent 60%),
        radial-gradient(620px 450px at 80% 70%, rgba(0,168,132,.15), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.10));
    }
    .viewerText{
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      padding:12px;
      line-height:1.4;
    }
    [data-theme="light"] .viewerText{
      background: rgba(255,255,255,.60);
      border:1px solid rgba(0,0,0,.10);
    }
    .viewerText .t1{font-weight:900; font-size:16px}
    .viewerText .t2{margin-top:8px; color: color-mix(in oklab, var(--muted), var(--text) 18%); font-size:13px}
    .replyRow{
      display:flex; gap:10px; align-items:center;
    }
    .replyRow input{
      flex:1;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color:var(--text);
      padding:12px 12px;
      border-radius: 16px;
      outline:none;
      font-size:14px;
    }
    [data-theme="light"] .replyRow input{
      border:1px solid rgba(0,0,0,.10);
      background: rgba(255,255,255,.65);
      color:var(--text);
    }
    .replyRow button{
      border:none;
      background: var(--green);
      color:white;
      padding:12px 14px;
      border-radius: 16px;
      font-weight:900;
      cursor:pointer;
    }

    /* Settings */
    .settings{
      flex:1;
      overflow:auto;
      padding:12px;
      min-height:0;
    }
    .card{
      background: color-mix(in oklab, var(--panel), transparent 0%);
      border:1px solid var(--line);
      border-radius: 18px;
      padding:12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.14);
      margin-bottom:12px;
    }
    .card h3{margin:0 0 10px;font-size:14px}
    .row{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 0;
      border-top:1px solid var(--line);
    }
    .row:first-of-type{border-top:none}
    .row .k{color:var(--muted); font-size:13px}
    .row .v{font-weight:800}
    .pillBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-weight:800;
      cursor:pointer;
    }
    .dangerBtn{
      border:1px solid color-mix(in oklab, var(--danger), transparent 55%);
      background: rgba(239,68,68,.12);
      color: color-mix(in oklab, var(--danger), var(--text) 25%);
    }

    /* Onboarding overlay */
    .overlay{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.72);
      z-index:80;
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .overlay.open{display:flex}
    .sheet{
      width:min(560px, 100%);
      background: color-mix(in oklab, var(--panel), black 6%);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 22px;
      box-shadow: 0 20px 60px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .sheetTop{
      padding:12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .sheetTop .ttl{font-weight:900}
    .sheetBody{
      padding:12px;
      max-height: 70vh;
      overflow:auto;
    }
    .qBubble{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding:10px 12px;
      margin:10px 0;
      line-height:1.4;
    }
    .choices{
      display:flex; flex-wrap:wrap; gap:8px;
      margin:10px 0 14px;
    }
    .choice{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-weight:800;
      user-select:none;
    }
    .choice:hover{background: rgba(255,255,255,.06)}
    .fine{font-size:12px;color:var(--muted); margin-top:8px}

    /* Small toast */
    .toast{
      position:fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 74px;
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      z-index:90;
      display:none;
      max-width:min(560px, 92%);
      backdrop-filter: blur(10px);
      font-size:13px;
    }
    .toast.show{display:block}
  </style>
</head>

<body data-route="home">
  <div class="app" id="app">
    <!-- Desktop top bar -->
    <div class="topbar" aria-label="Top bar">
      <div class="brand">
        <div class="dot"></div>
        <div>Money AI</div>
      </div>
      <div class="top-actions">
        <button class="iconbtn" id="btnReelsTop" title="Reels">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 6h16M7 6l2-3m6 3l2-3M6 10h12a2 2 0 0 1 2 2v6a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3v-6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
        </button>
        <button class="iconbtn" id="btnSettingsTop" title="Settings">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.7"/><path d="M19.4 15a8 8 0 0 0 .1-1 8 8 0 0 0-.1-1l2-1.5-2-3.5-2.3.7a7.8 7.8 0 0 0-1.7-1L15 4h-6l-.4 2.7a7.8 7.8 0 0 0-1.7 1L4.6 7 2.6 10.5l2 1.5a8 8 0 0 0 0 2l-2 1.5 2 3.5 2.3-.7a7.8 7.8 0 0 0 1.7 1L9 20h6l.4-2.7a7.8 7.8 0 0 0 1.7-1l2.3.7 2-3.5-2-1.5Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" opacity=".9"/></svg>
        </button>
      </div>
    </div>

    <div class="content">
      <!-- LEFT: Chats list -->
      <div class="leftPane" aria-label="Chats list">
        <div class="searchRow">
          <div class="search">
            <svg viewBox="0 0 24 24" fill="none"><path d="M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15Z" stroke="currentColor" stroke-width="1.7"/><path d="M16.5 16.5 21 21" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
            <input id="searchInput" placeholder="Search chats" autocomplete="off" />
          </div>
        </div>

        <div class="storiesStrip" id="storiesStrip" aria-label="Stories strip"></div>

        <div class="list" id="chatList" aria-label="Chat list"></div>
      </div>

      <!-- RIGHT: Router views (chat / reels / settings) -->
      <div class="rightPane" aria-label="Main view">
        <!-- Chat view -->
        <div id="chatView" style="display:none; flex:1; flex-direction:column; min-height:0;">
          <div class="chatHeader" id="chatHeader">
            <button class="iconbtn backBtn" id="btnBack" title="Back">
              <svg viewBox="0 0 24 24" fill="none"><path d="M15 18 9 12l6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div class="who">
              <div class="avatarRing read" style="width:40px;height:40px;padding:2px;">
                <div class="avatar" id="chatAvatar" style="border-width:0"></div>
              </div>
              <div style="min-width:0">
                <div class="whoName" id="chatName">‚Äî</div>
                <div class="status" id="chatStatus">‚Äî</div>
              </div>
            </div>
            <div class="hdrActions">
              <button class="iconbtn" id="btnCouncil" title="Council (group)">
                <svg viewBox="0 0 24 24" fill="none"><path d="M7 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6Zm10 0a3 3 0 1 1 0-6 3 3 0 0 1 0 6Z" stroke="currentColor" stroke-width="1.7"/><path d="M4 20a4 4 0 0 1 6-3.46M20 20a4 4 0 0 0-6-3.46M12 13a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" stroke="currentColor" stroke-width="1.2" opacity=".9"/></svg>
              </button>
              <button class="iconbtn" id="btnInfo" title="Info">
                <svg viewBox="0 0 24 24" fill="none"><path d="M12 22a10 10 0 1 1 0-20 10 10 0 0 1 0 20Z" stroke="currentColor" stroke-width="1.7"/><path d="M12 10v7" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M12 7h.01" stroke="currentColor" stroke-width="2.6" stroke-linecap="round"/></svg>
              </button>
            </div>
          </div>

          <div class="thread" id="thread" aria-label="Chat thread"></div>

          <div class="composer">
            <div class="quick" aria-label="Quick actions">
              <button class="iconbtn" id="qaMission" title="Mission">
                <svg viewBox="0 0 24 24" fill="none"><path d="M7 6h10M7 12h10M7 18h6" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M5 4h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H9l-4 2v-2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.1" opacity=".9"/></svg>
              </button>
              <button class="iconbtn" id="qaTimeAudit" title="Time audit">
                <svg viewBox="0 0 24 24" fill="none"><path d="M12 8v5l3 2" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="currentColor" stroke-width="1.7"/></svg>
              </button>
              <button class="iconbtn" id="qaMoneyMap" title="Money map">
                <svg viewBox="0 0 24 24" fill="none"><path d="M4 6h16v12H4V6Z" stroke="currentColor" stroke-width="1.7"/><path d="M8 10h8M8 14h5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
              </button>
            </div>

            <div class="inputWrap">
              <textarea id="msgInput" rows="1" placeholder="Message‚Ä¶" aria-label="Message input"></textarea>
            </div>
            <button class="sendBtn" id="btnSend" aria-label="Send">
              <svg viewBox="0 0 24 24" fill="none"><path d="M22 2 11 13" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M22 2 15 22l-4-9-9-4 20-7Z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/></svg>
            </button>
          </div>
        </div>

        <!-- Reels view -->
        <div id="reelsView" class="reelsWrap" style="display:none;">
          <div class="reelsHeader">
            <button class="iconbtn backBtn" id="btnBack2" title="Back">
              <svg viewBox="0 0 24 24" fill="none"><path d="M15 18 9 12l6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div style="font-weight:900">Reels</div>
            <div style="display:flex; gap:8px;">
              <button class="iconbtn" id="btnMarkAllReelsRead" title="Mark all read">
                <svg viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </button>
            </div>
          </div>
          <div class="reelsGrid" id="reelsGrid"></div>
        </div>

        <!-- Settings view -->
        <div id="settingsView" style="display:none; flex:1; flex-direction:column; min-height:0;">
          <div class="reelsHeader">
            <button class="iconbtn backBtn" id="btnBack3" title="Back">
              <svg viewBox="0 0 24 24" fill="none"><path d="M15 18 9 12l6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <div style="font-weight:900">Settings</div>
            <div style="width:38px"></div>
          </div>

          <div class="settings" id="settingsPane">
            <div class="card">
              <h3>Appearance</h3>
              <div class="row">
                <div>
                  <div class="v">Theme</div>
                  <div class="k">Auto / Dark / Light</div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
                  <button class="pillBtn" data-themePick="auto">Auto</button>
                  <button class="pillBtn" data-themePick="dark">Dark</button>
                  <button class="pillBtn" data-themePick="light">Light</button>
                </div>
              </div>
              <div class="row">
                <div>
                  <div class="v">Typing dots</div>
                  <div class="k">Small human pauses (recommended)</div>
                </div>
                <button class="pillBtn" id="toggleTypingDots">On</button>
              </div>
            </div>

            <div class="card">
              <h3>Privacy</h3>
              <div class="row">
                <div>
                  <div class="v">Export data</div>
                  <div class="k">Local JSON file (no cloud)</div>
                </div>
                <button class="pillBtn" id="btnExport">Export</button>
              </div>
              <div class="row">
                <div>
                  <div class="v">Delete all local data</div>
                  <div class="k">Permanent</div>
                </div>
                <button class="pillBtn dangerBtn" id="btnWipe">Delete</button>
              </div>
            </div>

            <div class="card">
              <h3>About</h3>
              <div class="row">
                <div>
                  <div class="v">Local-first</div>
                  <div class="k">Chats and reels are stored on-device.</div>
                </div>
                <div class="k">v1</div>
              </div>
              <div class="row">
                <div>
                  <div class="v">Install</div>
                  <div class="k">Add to Home Screen for full PWA</div>
                </div>
                <button class="pillBtn" id="btnInstall" disabled>Install</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Empty state -->
        <div id="emptyState" style="flex:1; display:flex; align-items:center; justify-content:center; padding:22px;">
          <div style="max-width:520px; text-align:center;">
            <div style="font-weight:900; font-size:22px;">Your circle is ready.</div>
            <div style="color:var(--muted); margin-top:10px; line-height:1.4;">
              Tap a contact to start. Reels are daily micro-stories that always end in a DM hook.
            </div>
            <div style="margin-top:16px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
              <button class="pillBtn" id="btnStartOnboarding">Start (2 min)</button>
              <button class="pillBtn" id="btnOpenReels">Open Reels</button>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Mobile tabs -->
    <div class="tabs" aria-label="Bottom tabs">
      <div class="tab active" id="tabChats" data-tab="home">
        <div class="pill" id="badgeChats">0</div>
        <svg viewBox="0 0 24 24" fill="none"><path d="M5 4h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H9l-4 2v-2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.7" stroke-linejoin="round"/></svg>
        <div style="font-size:11px;font-weight:800;">Chats</div>
      </div>
      <div class="tab" id="tabReels" data-tab="reels">
        <div class="pill" id="badgeReels">0</div>
        <svg viewBox="0 0 24 24" fill="none"><path d="M4 6h16M7 6l2-3m6 3l2-3M6 10h12a2 2 0 0 1 2 2v6a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3v-6a2 2 0 0 1 2-2Z" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
        <div style="font-size:11px;font-weight:800;">Reels</div>
      </div>
      <div class="tab" id="tabSettings" data-tab="settings">
        <svg viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="currentColor" stroke-width="1.7"/><path d="M19.4 15a8 8 0 0 0 .1-1 8 8 0 0 0-.1-1l2-1.5-2-3.5-2.3.7a7.8 7.8 0 0 0-1.7-1L15 4h-6l-.4 2.7a7.8 7.8 0 0 0-1.7 1L4.6 7 2.6 10.5l2 1.5a8 8 0 0 0 0 2l-2 1.5 2 3.5 2.3-.7a7.8 7.8 0 0 0 1.7 1L9 20h6l.4-2.7a7.8 7.8 0 0 0 1.7-1l2.3.7 2-3.5-2-1.5Z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round" opacity=".9"/></svg>
        <div style="font-size:11px;font-weight:800;">Settings</div>
      </div>
    </div>
  </div>

  <!-- Context menu -->
  <div class="menu" id="menu" role="menu" aria-hidden="true"></div>

  <!-- Reel viewer -->
  <div class="viewer" id="viewer" aria-hidden="true">
    <div class="viewerCard" role="dialog" aria-modal="true" aria-label="Reel viewer">
      <div class="viewerTop">
        <div style="display:flex; gap:10px; align-items:center; min-width:0">
          <div class="avatarRing read" style="width:38px;height:38px;padding:2px;">
            <div class="avatar" id="viewerAvatar" style="border-width:0"></div>
          </div>
          <div style="min-width:0">
            <div style="font-weight:900" id="viewerName">‚Äî</div>
            <div style="font-size:12px;color:var(--muted)" id="viewerDate">‚Äî</div>
          </div>
        </div>
        <button class="iconbtn" id="btnCloseViewer" title="Close">
          <svg viewBox="0 0 24 24" fill="none"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="progress"><div class="bar" id="viewerBar"></div></div>
      <div class="viewerBody">
        <div class="viewerText">
          <div class="t1" id="viewerLine1">‚Äî</div>
          <div class="t2" id="viewerLines">‚Äî</div>
        </div>
        <div class="replyRow">
          <input id="viewerReply" placeholder="Reply‚Ä¶ (opens DM)" autocomplete="off" />
          <button id="btnViewerSend">Send</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Onboarding -->
  <div class="overlay" id="onboarding" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-label="Onboarding">
      <div class="sheetTop">
        <div class="ttl">Quick start</div>
        <button class="iconbtn" id="btnCloseOnboarding" title="Close">
          <svg viewBox="0 0 24 24" fill="none"><path d="M18 6 6 18M6 6l12 12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        </button>
      </div>
      <div class="sheetBody" id="onboardingBody"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (function(){
    "use strict";

    // ---------------------------
    // Utilities
    // ---------------------------
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
    const now = ()=>Date.now();
    const pad2 = n => String(n).padStart(2,"0");
    const dayKey = (ts=Date.now())=>{
      const d = new Date(ts);
      return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate());
    };
    const fmtTime = (ts)=>{
      const d = new Date(ts);
      let h = d.getHours(), m = d.getMinutes();
      const ampm = h>=12 ? "PM":"AM";
      h = h%12; if(h===0) h=12;
      return `${h}:${pad2(m)} ${ampm}`;
    };
    const fmtShortDate = (ts)=>{
      const d = new Date(ts);
      return d.toLocaleDateString(undefined,{month:"short",day:"numeric"});
    };
    const toast = (msg)=>{
      const t = $("#toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove("show"), 2200);
    };

    // Auto-resize textarea
    function autoGrow(el){
      el.style.height = "auto";
      el.style.height = Math.min(120, el.scrollHeight) + "px";
    }

    // ---------------------------
    // Minimal IndexedDB wrapper
    // ---------------------------
    const DB = {
      name: "moneyai_pwa_v1",
      version: 1,
      db: null,
      async open(){
        if(DB.db) return DB.db;
        DB.db = await new Promise((resolve,reject)=>{
          const req = indexedDB.open(DB.name, DB.version);
          req.onupgradeneeded = (e)=>{
            const db = req.result;
            const mk = (name, keyPath)=>{
              if(!db.objectStoreNames.contains(name)){
                db.createObjectStore(name, { keyPath });
              }
            };
            mk("contacts","id");
            mk("messages","id"); // id = `${chatId}:${ts}:${rand}`
            mk("threads","id");  // chat metadata: lastTs, pinned, muted, unread, lastPreview
            mk("reels","id");    // id = `${day}:${contactId}`
            mk("prefs","id");    // key-value
            mk("reads","id");    // read markers: reelsReadDay, threadLastReadTs
          };
          req.onsuccess = ()=>resolve(req.result);
          req.onerror = ()=>reject(req.error);
        });
        return DB.db;
      },
      tx(store, mode="readonly"){
        return DB.db.transaction(store, mode).objectStore(store);
      },
      async get(store, key){
        await DB.open();
        return await new Promise((resolve,reject)=>{
          const req = DB.tx(store).get(key);
          req.onsuccess = ()=>resolve(req.result || null);
          req.onerror = ()=>reject(req.error);
        });
      },
      async put(store, val){
        await DB.open();
        return await new Promise((resolve,reject)=>{
          const req = DB.tx(store,"readwrite").put(val);
          req.onsuccess = ()=>resolve(true);
          req.onerror = ()=>reject(req.error);
        });
      },
      async del(store, key){
        await DB.open();
        return await new Promise((resolve,reject)=>{
          const req = DB.tx(store,"readwrite").delete(key);
          req.onsuccess = ()=>resolve(true);
          req.onerror = ()=>reject(req.error);
        });
      },
      async all(store){
        await DB.open();
        return await new Promise((resolve,reject)=>{
          const req = DB.tx(store).getAll();
          req.onsuccess = ()=>resolve(req.result || []);
          req.onerror = ()=>reject(req.error);
        });
      },
      async clearAll(){
        await DB.open();
        const stores = ["contacts","messages","threads","reels","prefs","reads"];
        for(const s of stores){
          await new Promise((resolve,reject)=>{
            const req = DB.tx(s,"readwrite").clear();
            req.onsuccess=()=>resolve(true);
            req.onerror=()=>reject(req.error);
          });
        }
      }
    };

    // ---------------------------
    // Avatars (inline SVG, consistent style)
    // ---------------------------
    function avatarSVG(seed, label, accent){
      // Deterministic-ish from seed
      let h = 0;
      for(let i=0;i<seed.length;i++) h = (h*31 + seed.charCodeAt(i))>>>0;
      const a = (h%360);
      const b = ((h>>>8)%360);
      const c = ((h>>>16)%360);
      const bg1 = `hsl(${a} 70% 35%)`;
      const bg2 = `hsl(${b} 70% 30%)`;
      const fg = accent || `hsl(${c} 80% 70%)`;
      const initials = (label||seed).trim().split(/\s+/).slice(0,2).map(s=>s[0]?.toUpperCase()||"").join("");
      const svg =
        `<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120">
          <defs>
            <radialGradient id="g" cx="30%" cy="20%" r="80%">
              <stop offset="0%" stop-color="${bg1}" stop-opacity="1"/>
              <stop offset="100%" stop-color="${bg2}" stop-opacity="1"/>
            </radialGradient>
            <filter id="s" x="-20%" y="-20%" width="140%" height="140%">
              <feDropShadow dx="0" dy="6" stdDeviation="8" flood-color="rgba(0,0,0,.35)"/>
            </filter>
          </defs>
          <circle cx="60" cy="60" r="58" fill="url(#g)"/>
          <circle cx="60" cy="60" r="54" fill="rgba(255,255,255,.06)"/>
          <circle cx="60" cy="52" r="20" fill="rgba(0,0,0,.18)"/>
          <path d="M22 108c8-22 26-34 38-34s30 12 38 34" fill="rgba(0,0,0,.20)"/>
          <text x="60" y="64" text-anchor="middle" font-family="ui-sans-serif,system-ui" font-size="26" font-weight="900" fill="${fg}" filter="url(#s)">${initials}</text>
        </svg>`;
      return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
    }
    function setAvatar(el, contact){
      const img = document.createElement("img");
      img.alt = contact.name;
      img.src = contact.avatarDataUrl;
      img.style.width="100%";
      img.style.height="100%";
      img.style.objectFit="cover";
      el.replaceChildren(img);
    }

    // ---------------------------
    // Seed: Contacts + statuses + voices + starter threads
    // ---------------------------
    const CONTACTS = [
      { id:"omar",  name:"Omar",  status:"Make it easy.", role:"simplifier", accent:"#caa64a" },
      { id:"zaid",  name:"Zaid",  status:"Fast wins only.", role:"mover", accent:"#00a884" },
      { id:"kareem",name:"Kareem",status:"More. But smarter.", role:"builder", accent:"#caa64a" },
      { id:"maya",  name:"Maya",  status:"Discipline is freedom.", role:"architect", accent:"#00a884" },
      { id:"salma", name:"Salma", status:"Breathe. Then move.", role:"stabilizer", accent:"#caa64a" },
      { id:"hakim", name:"Hakim", status:"Stories hide truth better than facts.", role:"storyteller", accent:"#00a884" }
    ];

    const STARTERS = {
      omar: [
        "Yo üòÑ quick check. You tired‚Ä¶ or stuck?",
        "Don‚Äôt answer deep. Just real.",
        "What wastes your time the most lately?",
        "Yep. That one kills people quietly.",
        "Listen: you‚Äôre not broke. Your day is just messy.",
        "Today we delete ONE stupid decision.",
        "Food tonight: anything simple. No scrolling. Deal?",
        "Clothes tomorrow: first clean thing. 30 seconds.",
        "That alone frees brain space.",
        "Now tell me‚Äîwhat problem around you annoys people daily?",
        "Pick ONE: transport / groceries / paperwork / something else",
        "Good. Tomorrow we test it with 3 people. Easy money, no drama."
      ],
      zaid: [
        "We‚Äôre getting a win in 48 hours.",
        "What do you need: money today, or time today?",
        "Name one thing you waste hours on daily.",
        "Cool. That‚Äôs your leak.",
        "3 hours/day = ~15 units burned. Stop feeding it.",
        "Tonight: no scrolling after 10. Simple.",
        "Tomorrow: message 3 people. I‚Äôll write it.",
        "Send: ‚ÄúIf I save you time with ___ this week, would you pay a small fee?‚Äù",
        "Don‚Äôt negotiate. Just send.",
        "Who are the 3? friend / neighbor / coworker",
        "After you send: yes/no/maybe. That‚Äôs all.",
        "Then we pick the fastest yes and deliver."
      ],
      kareem: [
        "I don‚Äôt care about motivation. I care about leverage.",
        "What do you do that you keep repeating?",
        "That repetition is a system waiting to exist.",
        "Right now you‚Äôre hunting. We need a pen.",
        "What‚Äôs one thing people ALWAYS need around you?",
        "Transport? Food? Admin? Any ‚Äúwheat‚Äù problem?",
        "Good. Now we add 2 drivers: speed + security.",
        "Your offer must say: ‚Äúfaster + safer + less headache‚Äù.",
        "What‚Äôs the smallest version you can sell this week?",
        "We test with 3 customers, then we repeat.",
        "After 3, we standardize: price + message + process.",
        "Then we automate one piece. That‚Äôs your first canal."
      ],
      maya: [
        "Okay. No chaos. We‚Äôll build structure.",
        "How many hours can you honestly control per week? 3? 5? 10?",
        "Good. We protect those hours like money.",
        "Your map has 3 lanes: cash / growth / assets.",
        "Cash lane: what pays you now?",
        "Growth lane: what skill raises your value?",
        "Asset lane: what can work without you?",
        "This week: 1 task per lane. Small. Non-negotiable.",
        "Cash: one quick offer to 3 people.",
        "Growth: 45 mins learn + 45 mins build.",
        "Asset: template/process so you stop repeating work.",
        "Sunday: we review. No emotions. Just progress."
      ],
      salma: [
        "Breathe. You‚Äôre not late. You‚Äôre overloaded.",
        "Tell me what‚Äôs scaring you most: bills, future, or failure?",
        "Okay. We‚Äôll shrink it.",
        "Today: 10 minutes. We list what you control.",
        "1) One expense you can pause.",
        "2) One hour you can protect.",
        "3) One small action that creates value.",
        "That‚Äôs how panic turns into power.",
        "Now: what‚Äôs one daily time-waste you can stop for 3 days?",
        "Good. You just bought yourself space.",
        "Next: choose a ‚Äòsafe‚Äô service you can offer nearby.",
        "When you do the first one, message me: ‚ÄúDone.‚Äù"
      ],
      hakim: [
        "Five farmers shared the same land. Same water. Same sun.",
        "One planted wheat. One tomatoes. One rice. One corn. One potatoes.",
        "Every season, people came asking only one question: ‚ÄúDo you have bread?‚Äù",
        "The wheat farmer slept well. The others worried about prices.",
        "Same effort. Different peace.",
        "If people knocked on your door tomorrow‚Ä¶ what would they need from you?"
      ]
    };

    // Reels (daily per contact; seeded examples)
    function defaultReelsForDay(day){
      const base = {
        omar: {
          title: "Being lazy made me rich.",
          lines: [
            "I just hated repeating the same work.",
            "So I built systems instead.",
            "DM me ‚ÄúHOW‚Äù."
          ],
          hook: "HOW"
        },
        zaid: {
          title: "Speed beats perfection.",
          lines: [
            "Money hates hesitation.",
            "Move today.",
            "DM me ‚ÄúNOW‚Äù."
          ],
          hook: "NOW"
        },
        kareem: {
          title: "Work once. Repeat.",
          lines: [
            "Your problem isn‚Äôt effort.",
            "It‚Äôs low leverage.",
            "DM me ‚ÄúSCALE‚Äù."
          ],
          hook: "SCALE"
        },
        maya: {
          title: "Discipline is relief.",
          lines: [
            "Chaos is expensive.",
            "Structure buys freedom.",
            "DM me ‚ÄúPLAN‚Äù."
          ],
          hook: "PLAN"
        },
        salma: {
          title: "Calm makes money.",
          lines: [
            "Panic feels urgent.",
            "Calm makes better decisions.",
            "DM me ‚ÄúBREATHE‚Äù."
          ],
          hook: "BREATHE"
        },
        hakim: {
          title: "Stories hide truth.",
          lines: [
            "Facts argue. Stories land.",
            "Let it sit.",
            "DM me ‚ÄúSTORY‚Äù."
          ],
          hook: "STORY"
        }
      };
      // Make Hakim weekly-ish: show only some days
      const d = new Date(day + "T00:00:00");
      const dow = d.getDay(); // 0 Sun
      if(dow !== 2 && dow !== 5){ // Tue/Fri only
        delete base.hakim;
      }
      return base;
    }

    // ---------------------------
    // App State
    // ---------------------------
    const state = {
      route: "home",
      activeChatId: null,
      contacts: [],
      threads: new Map(),  // chatId -> meta
      messages: new Map(), // chatId -> array
      reels: new Map(),    // reelId -> reel
      search: "",
      prefs: {
        theme: "auto",
        typingDots: true,
        onboarded: false,
        primaryContact: null
      },
      reads: {
        reelsRead: {}, // day -> {contactId:true}
        threadLastReadTs: {} // chatId -> ts
      },
      installPrompt: null
    };

    // ---------------------------
    // PWA manifest (single-file)
    // ---------------------------
    function setManifest(){
      const icons = [
        { size: 192, id:"icon-192" },
        { size: 512, id:"icon-512" }
      ].map(({size})=>{
        const svg = `
          <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 512 512">
            <defs>
              <radialGradient id="g" cx="30%" cy="20%" r="80%">
                <stop offset="0%" stop-color="#19c37d"/>
                <stop offset="100%" stop-color="#0b141a"/>
              </radialGradient>
              <linearGradient id="h" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0" stop-color="#caa64a" stop-opacity="0.95"/>
                <stop offset="1" stop-color="#00a884" stop-opacity="0.95"/>
              </linearGradient>
            </defs>
            <rect x="24" y="24" width="464" height="464" rx="120" fill="url(#g)"/>
            <rect x="70" y="70" width="372" height="372" rx="98" fill="rgba(255,255,255,0.06)"/>
            <path d="M140 170c0-24 20-44 44-44h144c24 0 44 20 44 44v90c0 24-20 44-44 44H240l-56 34v-34h-0c-24 0-44-20-44-44v-90Z" fill="rgba(0,0,0,0.24)"/>
            <path d="M154 164c0-20 16-36 36-36h132c20 0 36 16 36 36v74c0 20-16 36-36 36H240l-50 30v-30h-0c-20 0-36-16-36-36v-74Z" fill="url(#h)" opacity="0.92"/>
            <text x="256" y="250" text-anchor="middle" font-family="ui-sans-serif,system-ui" font-size="56" font-weight="900" fill="#0b141a">M</text>
            <text x="256" y="320" text-anchor="middle" font-family="ui-sans-serif,system-ui" font-size="38" font-weight="900" fill="rgba(255,255,255,0.90)">AI</text>
          </svg>`;
        return `data:image/svg+xml;charset=utf-8,${encodeURIComponent(svg)}`;
      });

      const manifest = {
        name: "Money AI",
        short_name: "Money AI",
        start_url: "./",
        scope: "./",
        display: "standalone",
        background_color: "#0b141a",
        theme_color: "#0b141a",
        icons: [
          { src: icons[0], sizes: "192x192", type: "image/svg+xml", purpose:"any maskable" },
          { src: icons[1], sizes: "512x512", type: "image/svg+xml", purpose:"any maskable" }
        ]
      };
      const blob = new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"});
      const url = URL.createObjectURL(blob);
      $("#manifestLink").setAttribute("href", url);
    }

    // ---------------------------
    // Service worker (single-file registration via Blob)
    // Offline strategy: cache current HTML as app-shell, serve it for navigations.
    // ---------------------------
    async function registerSW(){
      if(!("serviceWorker" in navigator)) return;
      const swCode = `
        const CACHE = "moneyai-shell-v1";
        const SHELL_KEY = "app-shell";
        self.addEventListener("install", (e)=>{
          e.waitUntil((async()=>{
            const cache = await caches.open(CACHE);
            try{
              const res = await fetch(self.registration.scope, {cache:"reload"});
              await cache.put(SHELL_KEY, res.clone());
            }catch(e){}
            self.skipWaiting();
          })());
        });

        self.addEventListener("activate", (e)=>{
          e.waitUntil((async()=>{
            const keys = await caches.keys();
            await Promise.all(keys.map(k => k===CACHE ? null : caches.delete(k)));
            self.clients.claim();
          })());
        });

        self.addEventListener("fetch", (e)=>{
          const req = e.request;
          const url = new URL(req.url);

          // Only handle same-origin
          if(url.origin !== location.origin) return;

          // Serve shell for navigations
          if(req.mode === "navigate"){
            e.respondWith((async()=>{
              const cache = await caches.open(CACHE);
              const cached = await cache.match(SHELL_KEY);
              try{
                const fresh = await fetch(req, {cache:"no-store"});
                await cache.put(SHELL_KEY, fresh.clone());
                return fresh;
              }catch(e){
                return cached || new Response("<h1>Offline</h1>", {headers:{"Content-Type":"text/html"}});
              }
            })());
            return;
          }

          // Other requests: cache-first then network
          e.respondWith((async()=>{
            const cache = await caches.open(CACHE);
            const hit = await cache.match(req);
            if(hit) return hit;
            try{
              const res = await fetch(req);
              // cache static-ish assets
              if(res && res.ok && (req.destination==="image" || req.destination==="style" || req.destination==="script")){
                cache.put(req, res.clone());
              }
              return res;
            }catch(e){
              return hit || new Response("", {status:504});
            }
          })());
        });
      `;
      const blob = new Blob([swCode], {type:"text/javascript"});
      const swUrl = URL.createObjectURL(blob);
      try{
        await navigator.serviceWorker.register(swUrl, {scope:"./"});
      }catch(e){
        // ignore
      }
    }

    // ---------------------------
    // Seed / Load
    // ---------------------------
    async function loadPrefs(){
      const prefRows = await DB.all("prefs");
      for(const r of prefRows){
        state.prefs[r.id] = r.value;
      }
      // defaults if missing
      if(typeof state.prefs.theme !== "string") state.prefs.theme = "auto";
      if(typeof state.prefs.typingDots !== "boolean") state.prefs.typingDots = true;
      if(typeof state.prefs.onboarded !== "boolean") state.prefs.onboarded = false;
      applyTheme(state.prefs.theme);
      $("#toggleTypingDots").textContent = state.prefs.typingDots ? "On" : "Off";
    }

    async function savePref(id, value){
      state.prefs[id] = value;
      await DB.put("prefs",{id,value});
    }

    async function loadReads(){
      const rows = await DB.all("reads");
      for(const r of rows){
        state.reads[r.id] = r.value;
      }
      if(!state.reads.reelsRead) state.reads.reelsRead = {};
      if(!state.reads.threadLastReadTs) state.reads.threadLastReadTs = {};
    }
    async function saveReads(){
      await DB.put("reads",{id:"reelsRead", value: state.reads.reelsRead});
      await DB.put("reads",{id:"threadLastReadTs", value: state.reads.threadLastReadTs});
    }

    async function ensureSeed(){
      const existing = await DB.all("contacts");
      if(existing.length){
        state.contacts = existing;
        return;
      }
      const contacts = CONTACTS.map(c=>{
        const avatarDataUrl = avatarSVG(c.id, c.name, c.accent);
        return {...c, avatarDataUrl};
      });
      for(const c of contacts) await DB.put("contacts", c);

      // Thread meta
      for(const c of contacts){
        const meta = {
          id: c.id,
          pinned: (c.id==="omar" || c.id==="hakim"), // Omar + Hakim pinned by default
          muted: false,
          unread: 0,
          lastTs: 0,
          lastPreview: ""
        };
        await DB.put("threads", meta);
      }

      // Starter messages (seed as "incoming")
      const baseTs = now() - 1000*60*60*6;
      let t = baseTs;
      for(const c of contacts){
        const arr = STARTERS[c.id] || [];
        for(const text of arr){
          t += 1000 * 30;
          await addMessage(c.id, "in", text, t, {silent:true});
        }
      }

      state.contacts = contacts;
      toast("Seeded your circle (local-only).");
    }

    async function loadAll(){
      state.contacts = await DB.all("contacts");
      const threads = await DB.all("threads");
      state.threads = new Map(threads.map(t=>[t.id, t]));
      const msgs = await DB.all("messages");
      state.messages = new Map();
      for(const m of msgs){
        if(!state.messages.has(m.chatId)) state.messages.set(m.chatId, []);
        state.messages.get(m.chatId).push(m);
      }
      // sort each chat by ts
      for(const [k,arr] of state.messages){
        arr.sort((a,b)=>a.ts-b.ts);
        state.messages.set(k,arr);
      }
      await ensureDailyReels();
    }

    // ---------------------------
    // Reels storage / daily refresh
    // ---------------------------
    async function ensureDailyReels(){
      const day = dayKey();
      const existing = await DB.all("reels");
      for(const r of existing) state.reels.set(r.id, r);

      // Seed today's reels if missing
      const todays = defaultReelsForDay(day);
      for(const [cid, r] of Object.entries(todays)){
        const id = `${day}:${cid}`;
        if(state.reels.has(id)) continue;
        const reel = {
          id,
          day,
          contactId: cid,
          title: r.title,
          lines: r.lines,
          hook: r.hook,
          createdTs: now(),
          seen: false
        };
        await DB.put("reels", reel);
        state.reels.set(id, reel);
      }
    }

    function isReelRead(day, contactId){
      return !!(state.reads.reelsRead?.[day]?.[contactId]);
    }
    function markReelRead(day, contactId){
      if(!state.reads.reelsRead[day]) state.reads.reelsRead[day] = {};
      state.reads.reelsRead[day][contactId] = true;
      saveReads();
    }

    // ---------------------------
    // Messages
    // ---------------------------
    function makeMsgId(chatId, ts){
      return `${chatId}:${ts}:${Math.random().toString(16).slice(2)}`;
    }
    async function addMessage(chatId, dir, text, ts=now(), {tag=null, chips=null, silent=false}={}){
      const msg = {
        id: makeMsgId(chatId, ts),
        chatId,
        dir,
        text,
        ts,
        tag,
        chips
      };
      await DB.put("messages", msg);
      if(!state.messages.has(chatId)) state.messages.set(chatId, []);
      state.messages.get(chatId).push(msg);
      state.messages.get(chatId).sort((a,b)=>a.ts-b.ts);

      // update thread meta
      const meta = state.threads.get(chatId) || {id:chatId,pinned:false,muted:false,unread:0,lastTs:0,lastPreview:""};
      meta.lastTs = ts;
      meta.lastPreview = text.replace(/\s+/g," ").slice(0,120);
      if(dir==="in" && !silent){
        const lastRead = state.reads.threadLastReadTs?.[chatId] || 0;
        if(ts > lastRead){
          meta.unread = (meta.unread||0) + 1;
        }
      }
      await DB.put("threads", meta);
      state.threads.set(chatId, meta);

      // update UI if active
      if(state.activeChatId === chatId && state.route==="chat"){
        renderThread();
        scrollThreadToBottom();
        // if user is viewing, mark as read
        await markThreadRead(chatId);
      }else{
        renderChatList();
      }
      updateBadges();
    }

    async function markThreadRead(chatId){
      const arr = state.messages.get(chatId) || [];
      const lastTs = arr.length ? arr[arr.length-1].ts : now();
      state.reads.threadLastReadTs[chatId] = lastTs;
      const meta = state.threads.get(chatId);
      if(meta){ meta.unread = 0; await DB.put("threads", meta); }
      await saveReads();
    }

    // ---------------------------
    // "AI" reply engine (local deterministic; replace with real LLM later)
    // ---------------------------
    function routerPick(chatId, userText){
      // If user opened from reel with keyword, route is naturally by chatId.
      // Otherwise use message content signals to optionally suggest Council.
      const t = (userText||"").toLowerCase();

      // quick crisis words -> Salma
      const crisis = ["panic","scared","anxious","bills","debt","late","stress","worried","fear","afraid"];
      const urgency = ["now","today","urgent","fast","quick","tomorrow","asap"];
      const scale = ["scale","business","system","repeat","leverage","grow","more","bigger","team"];
      const plan = ["plan","schedule","routine","discipline","week","month","structure"];
      const stuck = ["lazy","stuck","procrast","can't","tired","no energy","avoid"];

      let suggestCouncil = false;
      if((crisis.some(w=>t.includes(w)) && scale.some(w=>t.includes(w))) ||
         (urgency.some(w=>t.includes(w)) && plan.some(w=>t.includes(w))) ){
        suggestCouncil = true;
      }

      // default to active chat
      return { persona: chatId, suggestCouncil };
    }

    function makeChipsFor(chatId){
      // Quick actions: Mission / Time Audit / Money Map / Fast Win
      const base = [
        {label:"üéØ Mission", action:"mission"},
        {label:"üßæ Time Audit", action:"audit"},
        {label:"üß† Money Map", action:"map"},
        {label:"‚ö° Fast Win", action:"fastwin"},
      ];
      if(chatId==="hakim"){
        // Hakim doesn't do steps; only reflection.
        return [
          {label:"Tell me the 5 farmers story", action:"story_farmers"},
          {label:"Tell me the hunters story", action:"story_hunters"},
          {label:"One story for today", action:"story_today"}
        ];
      }
      return base;
    }

    function generateReply(chatId, userText){
      const t = (userText||"").trim();

      // If user used reel hook keyword
      const keyword = t.toUpperCase();
      const hooks = {
        omar:"HOW", zaid:"NOW", kareem:"SCALE", maya:"PLAN", salma:"BREATHE", hakim:"STORY"
      };
      if(keyword === hooks[chatId]){
        if(chatId==="omar"){
          return {
            tag:"Omar",
            text:"Cool.\nFirst question ‚Äî what do you repeat every day and hate?",
            chips: makeChipsFor(chatId)
          };
        }
        if(chatId==="zaid"){
          return {
            tag:"Zaid",
            text:"Good.\nPick ONE thing you can finish today in 45 minutes.\nName it.",
            chips: makeChipsFor(chatId)
          };
        }
        if(chatId==="kareem"){
          return {
            tag:"Kareem",
            text:"Alright.\nWhat‚Äôs the repeatable thing you can standardize this week?\nOne sentence.",
            chips: makeChipsFor(chatId)
          };
        }
        if(chatId==="maya"){
          return {
            tag:"Maya",
            text:"Deal.\nHow many hours can you realistically protect this week? (3 / 5 / 10)",
            chips: makeChipsFor(chatId)
          };
        }
        if(chatId==="salma"){
          return {
            tag:"Salma",
            text:"Breathe with me.\nIn 10 minutes we‚Äôll get control.\nWhat‚Äôs the main fear: bills, future, or failure?",
            chips: makeChipsFor(chatId)
          };
        }
        if(chatId==="hakim"){
          return {
            tag:"Hakim",
            text:"A story, then silence.\n\nTwo men hunted sheep.\nOne killed it every night.\nThe other tied it and fed it.\n\nSame skill. Different tomorrow.\n\nWhat are you killing daily‚Ä¶ that could be feeding you later?",
            chips: makeChipsFor(chatId)
          };
        }
      }

      // Hakim: stories only
      if(chatId==="hakim"){
        const lower = t.toLowerCase();
        if(lower.includes("farm") || lower.includes("farmer")){
          return { tag:"Hakim", text: STARTERS.hakim.join("\n"), chips: makeChipsFor(chatId) };
        }
        if(lower.includes("hunt") || lower.includes("hunter")){
          return { tag:"Hakim", text:
            "Two men hunted sheep.\nBoth caught one per day.\n\nOne killed it every night.\nThe other tied it and fed it.\n\nAfter weeks, one was tired.\nThe other stopped hunting.\n\nSame skill.\nDifferent tomorrow.\n\nWhat are you killing daily‚Ä¶ that could be feeding you later?",
            chips: makeChipsFor(chatId)
          };
        }
        // default: reflective
        return {
          tag:"Hakim",
          text:"Say it in one line.\nNot the plan.\nThe pattern.",
          chips: makeChipsFor(chatId)
        };
      }

      // Action contacts: short, human, mission-based
      const shePerHour = 5;
      const quickMath = (hours)=>{
        const units = Math.round(hours*shePerHour*10)/10;
        return `MATH: ~${units} units (${hours}h √ó 5)`;
      };

      if(chatId==="omar"){
        return {
          tag:"Omar",
          text:
`Okay.\nYou‚Äôre not ‚Äúbad‚Äù. You‚Äôre overloaded.\n\n${quickMath(2)} wasted = you paid with your day.\n\nMISSION:\n1) Delete ONE decision (food OR clothes) in 30 sec.\n2) Use the saved time for ONE useful thing.\n\nWhat‚Äôs the easiest decision to delete today?`,
          chips: makeChipsFor(chatId)
        };
      }
      if(chatId==="zaid"){
        return {
          tag:"Zaid",
          text:
`Do this today.\n\nMISSION:\n1) Pick one offer: ‚ÄúI save you time with ___.‚Äù\n2) Send it to 3 people.\n3) Screenshot replies (yes/no/maybe).\n\nWho are the 3?`,
          chips: makeChipsFor(chatId)
        };
      }
      if(chatId==="kareem"){
        return {
          tag:"Kareem",
          text:
`Mirror: Your problem isn‚Äôt effort. It‚Äôs low leverage.\n\nMISSION:\n1) Name one repeatable task you do weekly.\n2) Turn it into a template/process in 30 minutes.\n3) Sell the smallest version to 3 people.\n\nWhat‚Äôs the repeatable task?`,
          chips: makeChipsFor(chatId)
        };
      }
      if(chatId==="maya"){
        return {
          tag:"Maya",
          text:
`We‚Äôre building structure.\n\nMISSION (this week):\n1) Cash: one offer to 3 people.\n2) Growth: 45m learn + 45m build.\n3) Asset: template to stop repeating work.\n\nHow many hours can you protect this week: 3 / 5 / 10?`,
          chips: makeChipsFor(chatId)
        };
      }
      if(chatId==="salma"){
        return {
          tag:"Salma",
          text:
`We don‚Äôt need perfect clarity.\nWe need one step.\n\nChecklist (today):\n‚Ä¢ One expense you pause\n‚Ä¢ One hour you protect\n‚Ä¢ One action that creates value\n\nWhich one feels easiest right now?`,
          chips: makeChipsFor(chatId)
        };
      }
      return { tag:null, text:"‚Äî", chips: makeChipsFor(chatId) };
    }

    async function simulateTypingThenReply(chatId, reply){
      // optional typing dots
      if(state.prefs.typingDots){
        await addMessage(chatId, "in", "‚Ä¶", now(), {tag: reply.tag, silent:true});
        const arr = state.messages.get(chatId) || [];
        const dotMsg = arr[arr.length-1];
        const wait = 450 + Math.random()*650;
        await new Promise(r=>setTimeout(r, wait));
        // replace the dots message with real reply (delete + add)
        await DB.del("messages", dotMsg.id);
        arr.pop();
      }
      await addMessage(chatId, "in", reply.text, now(), {tag: reply.tag, chips: reply.chips});
    }

    // ---------------------------
    // Rendering
    // ---------------------------
    function sortContactsForList(contacts){
      const metas = contacts.map(c=>{
        const m = state.threads.get(c.id) || {pinned:false,lastTs:0,unread:0};
        return {c, m};
      });
      metas.sort((a,b)=>{
        // pinned first
        if(!!a.m.pinned !== !!b.m.pinned) return a.m.pinned ? -1 : 1;
        // latest first
        return (b.m.lastTs||0) - (a.m.lastTs||0);
      });
      return metas.map(x=>x.c);
    }

    function filterContacts(contacts){
      const q = (state.search||"").trim().toLowerCase();
      if(!q) return contacts;
      return contacts.filter(c=>{
        const m = state.threads.get(c.id);
        return c.name.toLowerCase().includes(q) || (m?.lastPreview||"").toLowerCase().includes(q);
      });
    }

    function renderStoriesStrip(){
      const strip = $("#storiesStrip");
      strip.innerHTML = "";
      const today = dayKey();
      const todaysReels = Array.from(state.reels.values()).filter(r=>r.day===today);

      // Only show contacts that have a reel today (Hakim can be absent)
      const byCid = new Map(todaysReels.map(r=>[r.contactId,r]));
      const contacts = sortContactsForList(state.contacts).filter(c=>byCid.has(c.id));

      for(const c of contacts){
        const reel = byCid.get(c.id);
        const read = isReelRead(today, c.id);
        const chip = document.createElement("div");
        chip.className = "storyChip";
        chip.innerHTML = `
          <div class="avatarRing ${read ? "read":""}">
            <div class="avatar" data-avatar="${c.id}"></div>
          </div>
          <div class="name">${c.name}</div>
        `;
        const avatarEl = chip.querySelector("[data-avatar]");
        setAvatar(avatarEl, c);
        chip.addEventListener("click", ()=>openReelViewer(reel));
        strip.appendChild(chip);
      }
    }

    function renderChatList(){
      const list = $("#chatList");
      list.innerHTML = "";
      const contacts = filterContacts(sortContactsForList(state.contacts));
      for(const c of contacts){
        const meta = state.threads.get(c.id) || {unread:0,lastPreview:"",lastTs:0,pinned:false};
        const row = document.createElement("div");
        row.className = "chatRow" +
          (state.activeChatId===c.id ? " active":"") +
          (meta.unread>0 ? " unread":"") +
          (meta.pinned ? " pinned":"");
        row.innerHTML = `
          <div class="pin" title="Pinned">
            <svg viewBox="0 0 24 24" fill="none"><path d="M14 3 7 10l4 4-6 6 6-6 4 4 7-7-8-8Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/></svg>
          </div>
          <div class="avatarRing read" style="width:52px;height:52px;padding:2px;">
            <div class="avatar" data-avatar="${c.id}"></div>
          </div>
          <div class="meta">
            <div class="top">
              <div class="title">${c.name}</div>
              <div class="time">${meta.lastTs ? fmtTime(meta.lastTs) : ""}</div>
            </div>
            <div class="bottom">
              <div class="preview">${meta.lastPreview || c.status}</div>
              <div class="badge">${meta.unread}</div>
            </div>
          </div>
        `;
        setAvatar(row.querySelector("[data-avatar]"), c);

        row.addEventListener("click", ()=>openChat(c.id));
        row.addEventListener("contextmenu", (e)=>{
          e.preventDefault();
          openMenuForChat(e.clientX, e.clientY, c.id);
        });
        row.addEventListener("pointerdown", (e)=>{
          // long press for touch
          if(e.pointerType !== "touch") return;
          let fired=false;
          const tm = setTimeout(()=>{
            fired=true;
            openMenuForChat(e.clientX, e.clientY, c.id);
          }, 520);
          const cancel=()=>clearTimeout(tm);
          row.addEventListener("pointerup", cancel, {once:true});
          row.addEventListener("pointercancel", cancel, {once:true});
          row.addEventListener("pointermove", ()=>{ if(!fired) clearTimeout(tm); }, {once:true});
        });

        list.appendChild(row);
      }
      renderStoriesStrip();
    }

    function renderThread(){
      const thread = $("#thread");
      const chatId = state.activeChatId;
      const contact = state.contacts.find(c=>c.id===chatId);
      if(!contact) return;

      // Header
      $("#chatName").textContent = contact.name;
      $("#chatStatus").textContent = contact.status;
      setAvatar($("#chatAvatar"), contact);

      const arr = state.messages.get(chatId) || [];
      thread.innerHTML = "";
      for(const m of arr){
        const row = document.createElement("div");
        row.className = "msgRow " + (m.dir==="out" ? "out":"in");

        const bubble = document.createElement("div");
        bubble.className = "bubble";

        let tagHtml = "";
        if(m.dir==="in" && m.tag){
          tagHtml = `<div class="tag"><span class="dot"></span><span>${m.tag}</span></div>`;
        }
        const textHtml = (m.text||"").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br/>");
        bubble.innerHTML = tagHtml + `<div class="txt">${textHtml}</div>`;

        // action chips on incoming messages
        if(m.dir==="in" && Array.isArray(m.chips) && m.chips.length){
          const actions = document.createElement("div");
          actions.className = "actions";
          for(const ch of m.chips){
            const btn = document.createElement("button");
            btn.className = "chipBtn";
            btn.textContent = ch.label;
            btn.addEventListener("click", ()=>handleChip(chatId, ch.action));
            actions.appendChild(btn);
          }
          bubble.appendChild(actions);
        }

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = fmtTime(m.ts);
        bubble.appendChild(meta);

        row.appendChild(bubble);
        thread.appendChild(row);
      }
    }

    function scrollThreadToBottom(){
      const thread = $("#thread");
      thread.scrollTop = thread.scrollHeight + 9999;
    }

    function updateBadges(){
      // chats unread count
      let unreadChats = 0;
      for(const t of state.threads.values()){
        unreadChats += (t.unread||0);
      }
      const tabChats = $("#tabChats");
      const badgeChats = $("#badgeChats");
      if(unreadChats>0){
        tabChats.classList.add("hasBadge");
        badgeChats.textContent = String(unreadChats);
      }else{
        tabChats.classList.remove("hasBadge");
      }

      // reels unread today
      const today = dayKey();
      const todaysReels = Array.from(state.reels.values()).filter(r=>r.day===today);
      let unreadReels = 0;
      for(const r of todaysReels){
        if(!isReelRead(today, r.contactId)) unreadReels++;
      }
      const tabReels = $("#tabReels");
      const badgeReels = $("#badgeReels");
      if(unreadReels>0){
        tabReels.classList.add("hasBadge");
        badgeReels.textContent = String(unreadReels);
      }else{
        tabReels.classList.remove("hasBadge");
      }
    }

    // ---------------------------
    // Routing (home/chat/reels/settings)
    // ---------------------------
    function setRoute(route){
      state.route = route;
      document.body.dataset.route = route;

      // desktop topbar exists; right pane chooses view
      const show = (id)=>$(id).style.display="flex";
      const hide = (id)=>$(id).style.display="none";

      hide("#chatView");
      hide("#reelsView");
      hide("#settingsView");
      $("#emptyState").style.display = "none";

      if(route==="chat"){
        show("#chatView");
      }else if(route==="reels"){
        show("#reelsView");
      }else if(route==="settings"){
        show("#settingsView");
      }else{
        // home: show empty only on desktop when no active chat
        if(window.matchMedia("(min-width: 841px)").matches){
          $("#emptyState").style.display = "flex";
        }else{
          // mobile home shows list only
          $("#emptyState").style.display = "none";
        }
      }

      // tabs state
      $$(".tab").forEach(t=>t.classList.remove("active"));
      if(route==="home") $("#tabChats").classList.add("active");
      if(route==="reels") $("#tabReels").classList.add("active");
      if(route==="settings") $("#tabSettings").classList.add("active");
    }

    async function openChat(chatId){
      state.activeChatId = chatId;

      // If in desktop, show chat view too
      setRoute("chat");
      renderChatList();
      renderThread();
      scrollThreadToBottom();
      await markThreadRead(chatId);
      updateBadges();
    }

    function openReels(){
      setRoute("reels");
      renderReelsGrid();
      updateBadges();
    }

    function openSettings(){
      setRoute("settings");
      updateBadges();
    }

    // ---------------------------
    // Menu actions
    // ---------------------------
    function openMenuForChat(x,y, chatId){
      const menu = $("#menu");
      const meta = state.threads.get(chatId) || {pinned:false,muted:false};
      const pinLabel = meta.pinned ? "Unpin":"Pin";
      const muteLabel = meta.muted ? "Unmute":"Mute";
      menu.innerHTML = `
        <div class="mi" data-act="pin">
          <svg viewBox="0 0 24 24" fill="none"><path d="M14 3 7 10l4 4-6 6 6-6 4 4 7-7-8-8Z" stroke="currentColor" stroke-width="1.4" stroke-linejoin="round"/></svg>
          <div>${pinLabel}</div>
        </div>
        <div class="mi" data-act="mute">
          <svg viewBox="0 0 24 24" fill="none"><path d="M11 5 6 9H3v6h3l5 4V5Z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M23 9 17 15M17 9l6 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          <div>${muteLabel}</div>
        </div>
        <div class="mi" data-act="export">
          <svg viewBox="0 0 24 24" fill="none"><path d="M12 3v12" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="m7 10 5 5 5-5" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/><path d="M5 21h14" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/></svg>
          <div>Export chat</div>
        </div>
        <div class="mi danger" data-act="clear">
          <svg viewBox="0 0 24 24" fill="none"><path d="M4 7h16" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M10 11v6M14 11v6" stroke="currentColor" stroke-width="1.7" stroke-linecap="round"/><path d="M6 7l1 14h10l1-14" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" opacity=".9"/><path d="M9 7V4h6v3" stroke="currentColor" stroke-width="1.2" opacity=".9"/></svg>
          <div>Clear chat</div>
        </div>
      `;
      const rect = menu.getBoundingClientRect();
      const left = clamp(x, 10, window.innerWidth - 10 - 240);
      const top = clamp(y, 10, window.innerHeight - 10 - 220);
      menu.style.left = left+"px";
      menu.style.top = top+"px";
      menu.classList.add("open");
      menu.setAttribute("aria-hidden","false");

      const onClick = async (e)=>{
        const mi = e.target.closest(".mi");
        if(!mi) return;
        const act = mi.dataset.act;
        if(act==="pin"){
          meta.pinned = !meta.pinned;
          await DB.put("threads", {...meta, id: chatId});
          state.threads.set(chatId, {...meta, id: chatId});
          toast(meta.pinned ? "Pinned" : "Unpinned");
        }else if(act==="mute"){
          meta.muted = !meta.muted;
          await DB.put("threads", {...meta, id: chatId});
          state.threads.set(chatId, {...meta, id: chatId});
          toast(meta.muted ? "Muted" : "Unmuted");
        }else if(act==="clear"){
          if(!confirm("Clear this chat locally?")) return;
          // delete messages for chat
          const arr = state.messages.get(chatId) || [];
          for(const m of arr) await DB.del("messages", m.id);
          state.messages.set(chatId, []);
          // reset thread meta
          const c = state.contacts.find(c=>c.id===chatId);
          const newMeta = {id:chatId, pinned:meta.pinned, muted:meta.muted, unread:0, lastTs:0, lastPreview: c ? c.status : ""};
          await DB.put("threads", newMeta);
          state.threads.set(chatId, newMeta);
          toast("Cleared");
          if(state.activeChatId===chatId){
            renderThread();
          }
        }else if(act==="export"){
          await exportChat(chatId);
        }
        closeMenu();
        renderChatList();
        updateBadges();
      };

      menu.onclick = onClick;

      const closeOn = (e)=>{
        if(e.target.closest("#menu")) return;
        closeMenu();
      };
      window.addEventListener("click", closeOn, {once:true});
      window.addEventListener("contextmenu", closeOn, {once:true});
    }

    function closeMenu(){
      const menu = $("#menu");
      menu.classList.remove("open");
      menu.setAttribute("aria-hidden","true");
    }

    // ---------------------------
    // Chips actions
    // ---------------------------
    async function handleChip(chatId, action){
      if(action==="mission"){
        await addMessage(chatId, "in", "TITLE: One tiny mission\nMIRROR: We don‚Äôt need more thinking. We need one move.\nMISSION:\n1) Pick 1 problem you can solve today.\n2) Make the smallest version.\n3) Send it to 3 people.\nCHECK-IN: What‚Äôs your smallest version?", now(), {tag: state.contacts.find(c=>c.id===chatId)?.name || null});
        scrollThreadToBottom();
        return;
      }
      if(action==="audit"){
        await addMessage(chatId, "in", "Time audit (10 min):\n‚Ä¢ Food decisions: ____\n‚Ä¢ Scrolling: ____\n‚Ä¢ Worry loops: ____\n\nPick ONE to cut by 30 minutes today.\nWhich one?", now(), {tag: state.contacts.find(c=>c.id===chatId)?.name || null});
        scrollThreadToBottom();
        return;
      }
      if(action==="map"){
        await addMessage(chatId, "in", "Money Map (simple):\nHunt ‚Üí Pen ‚Üí Farm ‚Üí Canal ‚Üí Village\n\nWhere are you today?\n(One job / side gig / repeatable / system / team)", now(), {tag: state.contacts.find(c=>c.id===chatId)?.name || null});
        scrollThreadToBottom();
        return;
      }
      if(action==="fastwin"){
        await addMessage(chatId, "in", "Fast win (24h):\nSend this to 3 people:\n‚ÄúCan I save you time with ___ this week?‚Äù\n\nReply with their yes/no/maybe.", now(), {tag: state.contacts.find(c=>c.id===chatId)?.name || null});
        scrollThreadToBottom();
        return;
      }
      if(action==="story_farmers"){
        await simulateTypingThenReply(chatId, {tag:"Hakim", text: STARTERS.hakim.join("\n"), chips: makeChipsFor("hakim")});
        return;
      }
      if(action==="story_hunters"){
        await simulateTypingThenReply(chatId, {tag:"Hakim", text:
          "Two men hunted sheep.\nBoth caught one per day.\n\nOne killed it every night.\nThe other tied it and fed it.\n\nAfter weeks, one was tired.\nThe other stopped hunting.\n\nSame skill.\nDifferent tomorrow.\n\nWhat are you killing daily‚Ä¶ that could be feeding you later?",
          chips: makeChipsFor("hakim")});
        return;
      }
      if(action==="story_today"){
        await simulateTypingThenReply(chatId, {tag:"Hakim", text:
          "Oil slept underground for centuries.\nWorth nothing.\n\nThen humans needed movement.\nOil became precious.\n\nWhen movement stopped, oil turned useless again.\n\nWas oil valuable‚Ä¶\nor human effort?",
          chips: makeChipsFor("hakim")});
        return;
      }
    }

    // ---------------------------
    // Reels UI
    // ---------------------------
    function renderReelsGrid(){
      const grid = $("#reelsGrid");
      grid.innerHTML = "";
      const today = dayKey();
      const todaysReels = Array.from(state.reels.values())
        .filter(r=>r.day===today)
        .sort((a,b)=>a.contactId.localeCompare(b.contactId));

      for(const r of todaysReels){
        const c = state.contacts.find(x=>x.id===r.contactId);
        if(!c) continue;
        const card = document.createElement("div");
        card.className = "reelCard";
        const read = isReelRead(today, c.id);
        card.innerHTML = `
          <div class="reelThumb">
            <div class="overlay">
              <div class="line1">${escapeHtml(r.title)}</div>
              <div class="line2">${escapeHtml((r.lines||[])[0] || "")}</div>
            </div>
          </div>
          <div class="reelMeta">
            <div class="left">
              <div class="avatarRing ${read ? "read":""}" style="width:36px;height:36px;padding:2px;">
                <div class="avatar" data-avatar="${c.id}"></div>
              </div>
              <div style="min-width:0">
                <div class="who">${c.name}</div>
                <div class="date">${fmtShortDate(Date.now())}</div>
              </div>
            </div>
            <div class="playPill">${read ? "Replay":"Play"}</div>
          </div>
        `;
        setAvatar(card.querySelector("[data-avatar]"), c);
        card.addEventListener("click", ()=>openReelViewer(r));
        grid.appendChild(card);
      }
    }

    function escapeHtml(s){
      return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    let viewerTimer = null;
    function openReelViewer(reel){
      const viewer = $("#viewer");
      const c = state.contacts.find(x=>x.id===reel.contactId);
      if(!c) return;

      setAvatar($("#viewerAvatar"), c);
      $("#viewerName").textContent = c.name;
      $("#viewerDate").textContent = fmtShortDate(Date.now());
      $("#viewerLine1").textContent = reel.title;
      $("#viewerLines").innerHTML = (reel.lines||[]).map(l=>escapeHtml(l)).join("<br/>");
      $("#viewerReply").value = "";

      viewer.classList.add("open");
      viewer.setAttribute("aria-hidden","false");

      // mark read
      markReelRead(reel.day, reel.contactId);
      renderStoriesStrip();
      renderReelsGrid();
      updateBadges();

      // progress bar
      const bar = $("#viewerBar");
      bar.style.width = "0%";
      clearInterval(viewerTimer);
      const dur = 9000; // 9s feel
      const start = Date.now();
      viewerTimer = setInterval(()=>{
        const p = clamp((Date.now()-start)/dur, 0, 1);
        bar.style.width = (p*100).toFixed(1) + "%";
        if(p>=1) clearInterval(viewerTimer);
      }, 50);
    }

    function closeViewer(){
      clearInterval(viewerTimer);
      $("#viewer").classList.remove("open");
      $("#viewer").setAttribute("aria-hidden","true");
    }

    async function viewerSendDM(){
      const name = $("#viewerName").textContent;
      const c = state.contacts.find(x=>x.name===name);
      if(!c) return;
      const msg = ($("#viewerReply").value||"").trim();
      if(!msg){
        // auto send hook if empty (use last line‚Äôs keyword if exists)
        const today = dayKey();
        const r = state.reels.get(`${today}:${c.id}`);
        if(r?.hook) $("#viewerReply").value = r.hook;
      }
      const final = ($("#viewerReply").value||"").trim();
      if(!final) return;

      closeViewer();
      await openChat(c.id);
      await addMessage(c.id, "out", final, now());
      const reply = generateReply(c.id, final);
      await simulateTypingThenReply(c.id, reply);
    }

    // ---------------------------
    // Onboarding (WhatsApp style quick replies)
    // ---------------------------
    const onboardingFlow = [
      {
        q: "Quick thing before we start.\nI won‚Äôt judge. I just need accuracy.",
        choices: ["Continue"],
        onPick: (v, o)=>{}
      },
      {
        q: "Yesterday‚Ä¶ how many hours did you lose on food decisions, scrolling, worrying, ‚Äúwhat now?‚Äù",
        choices: ["0‚Äì1","2‚Äì3","4‚Äì5","6+"],
        onPick: (v,o)=>{ o.lostHours = v; }
      },
      {
        q: "When money feels tight, what hits you first?",
        choices: ["I feel tired / lazy","I panic, need fast relief","I want MORE, bigger moves","I feel behind others","I worry about safety"],
        onPick: (v,o)=>{ o.driver = v; }
      },
      {
        q: "Be honest. Which sounds more like you?",
        choices: ["I overthink small stuff","I rush decisions","I delay everything","I plan but don‚Äôt execute","I avoid risks"],
        onPick: (v,o)=>{ o.style = v; }
      },
      {
        q: "Right now, your money mostly comes from‚Ä¶",
        choices: ["One job / daily grind","Side gigs","Something repeatable","Systems / automation","People working with me"],
        onPick: (v,o)=>{ o.stage = v; }
      },
      {
        q: "Deal check ü§ù\nI‚Äôll keep things simple and real.\nYou try the actions, not just read.",
        choices: ["Deal","Let‚Äôs try"],
        onPick: (v,o)=>{}
      }
    ];

    function pickPrimaryContact(o){
      // driver -> contact
      const d = (o.driver||"").toLowerCase();
      if(d.includes("panic") || d.includes("safety")) return "salma";
      if(d.includes("more")) return "kareem";
      if(d.includes("behind")) return "maya";
      if(d.includes("tired") || d.includes("lazy")) return "omar";
      // style overrides
      const s = (o.style||"").toLowerCase();
      if(s.includes("rush")) return "zaid";
      if(s.includes("plan")) return "maya";
      return "omar";
    }

    function openOnboarding(){
      const ov = $("#onboarding");
      const body = $("#onboardingBody");
      body.innerHTML = "";
      ov.classList.add("open");
      ov.setAttribute("aria-hidden","false");

      const answers = {};
      let step = 0;

      const renderStep = ()=>{
        body.innerHTML = "";
        const item = onboardingFlow[step];

        const bubble = document.createElement("div");
        bubble.className = "qBubble";
        bubble.innerHTML = escapeHtml(item.q).replace(/\n/g,"<br/>");
        body.appendChild(bubble);

        const ch = document.createElement("div");
        ch.className = "choices";
        for(const c of item.choices){
          const btn = document.createElement("div");
          btn.className = "choice";
          btn.textContent = c;
          btn.addEventListener("click", async ()=>{
            item.onPick(c, answers);
            step++;
            if(step >= onboardingFlow.length){
              const primary = pickPrimaryContact(answers);
              await savePref("onboarded", true);
              await savePref("primaryContact", primary);
              // pin primary and move to top
              const meta = state.threads.get(primary) || {id:primary,pinned:false,muted:false,unread:0,lastTs:0,lastPreview:""};
              meta.pinned = true;
              await DB.put("threads", meta);
              state.threads.set(primary, meta);

              closeOnboarding();

              toast(`Pinned ${state.contacts.find(x=>x.id===primary)?.name || "your best contact"}.`);
              renderChatList();
              await openChat(primary);
              // send a gentle first nudge from that contact (not spam)
              if((state.messages.get(primary)||[]).length < 20){
                await addMessage(primary, "in", "Quick check ‚Äî what‚Äôs the one thing you want fixed first: time, money, or stress?", now(), {tag: state.contacts.find(x=>x.id===primary)?.name || null});
              }
              return;
            }
            renderStep();
          });
          ch.appendChild(btn);
        }
        body.appendChild(ch);

        const fine = document.createElement("div");
        fine.className = "fine";
        fine.textContent = "No account. Everything stays on this device.";
        body.appendChild(fine);
      };

      renderStep();
    }

    function closeOnboarding(){
      const ov = $("#onboarding");
      ov.classList.remove("open");
      ov.setAttribute("aria-hidden","true");
    }

    // ---------------------------
    // Export
    // ---------------------------
    async function exportAll(){
      const payload = {
        exportedAt: new Date().toISOString(),
        contacts: await DB.all("contacts"),
        threads: await DB.all("threads"),
        messages: await DB.all("messages"),
        reels: await DB.all("reels"),
        prefs: await DB.all("prefs"),
        reads: await DB.all("reads")
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
      downloadBlob(blob, `moneyai_export_${dayKey()}.json`);
    }

    async function exportChat(chatId){
      const c = state.contacts.find(x=>x.id===chatId);
      const payload = {
        exportedAt: new Date().toISOString(),
        chat: c,
        thread: state.threads.get(chatId),
        messages: (state.messages.get(chatId)||[])
      };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
      downloadBlob(blob, `moneyai_chat_${chatId}_${dayKey()}.json`);
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }

    // ---------------------------
    // Theme
    // ---------------------------
    function applyTheme(mode){
      if(mode==="auto"){
        const prefersDark = window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
        document.documentElement.setAttribute("data-theme", prefersDark ? "dark":"light");
      }else{
        document.documentElement.setAttribute("data-theme", mode);
      }
    }

    // ---------------------------
    // Events / UI wiring
    // ---------------------------
    function wireUI(){
      // Tabs
      $("#tabChats").addEventListener("click", ()=>{ setRoute("home"); });
      $("#tabReels").addEventListener("click", ()=>{ openReels(); });
      $("#tabSettings").addEventListener("click", ()=>{ openSettings(); });

      // Top actions
      $("#btnReelsTop").addEventListener("click", ()=>openReels());
      $("#btnSettingsTop").addEventListener("click", ()=>openSettings());

      // Back
      $("#btnBack").addEventListener("click", ()=>{ setRoute("home"); });
      $("#btnBack2").addEventListener("click", ()=>{ setRoute("home"); });
      $("#btnBack3").addEventListener("click", ()=>{ setRoute("home"); });

      // Empty state buttons
      $("#btnStartOnboarding").addEventListener("click", openOnboarding);
      $("#btnOpenReels").addEventListener("click", openReels);

      // Search
      $("#searchInput").addEventListener("input", (e)=>{
        state.search = e.target.value || "";
        renderChatList();
      });

      // Send
      const input = $("#msgInput");
      input.addEventListener("input", ()=>autoGrow(input));
      $("#btnSend").addEventListener("click", sendMessage);
      input.addEventListener("keydown", (e)=>{
        if(e.key==="Enter" && !e.shiftKey){
          e.preventDefault();
          sendMessage();
        }
      });

      // Quick actions
      $("#qaMission").addEventListener("click", ()=>handleChip(state.activeChatId, "mission"));
      $("#qaTimeAudit").addEventListener("click", ()=>handleChip(state.activeChatId, "audit"));
      $("#qaMoneyMap").addEventListener("click", ()=>handleChip(state.activeChatId, "map"));

      // Council button (simple local simulation)
      $("#btnCouncil").addEventListener("click", async ()=>{
        const cid = state.activeChatId;
        if(!cid) return;
        const text =
`Abundance Council (short takes):\n\nOmar: Make it easier. Delete one decision.\nZaid: Move today. One message to 3 people.\nKareem: Build leverage. Repeatable offer.\nMaya: Structure the week. 3 lanes.\nSalma: Reduce panic. One controllable step.\n\nModerator: Pick ONE action now. What do you choose?`;
        await addMessage(cid, "in", text, now(), {tag:"Council", chips: makeChipsFor(cid)});
        scrollThreadToBottom();
      });

      // Info button
      $("#btnInfo").addEventListener("click", ()=>{
        const cid = state.activeChatId;
        const c = state.contacts.find(x=>x.id===cid);
        if(!c) return;
        toast(`${c.name}: ${c.status}`);
      });

      // Reel viewer
      $("#btnCloseViewer").addEventListener("click", closeViewer);
      $("#viewer").addEventListener("click", (e)=>{ if(e.target.id==="viewer") closeViewer(); });
      $("#btnViewerSend").addEventListener("click", viewerSendDM);
      $("#viewerReply").addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); viewerSendDM(); } });

      // Mark all reels read
      $("#btnMarkAllReelsRead").addEventListener("click", ()=>{
        const today = dayKey();
        const todaysReels = Array.from(state.reels.values()).filter(r=>r.day===today);
        for(const r of todaysReels) markReelRead(today, r.contactId);
        renderStoriesStrip();
        renderReelsGrid();
        updateBadges();
        toast("Reels marked read");
      });

      // Onboarding
      $("#btnStartOnboarding").addEventListener("click", openOnboarding);
      $("#btnCloseOnboarding").addEventListener("click", closeOnboarding);

      // Settings: theme pick
      $$("[data-themePick]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const v = btn.getAttribute("data-themePick");
          await savePref("theme", v);
          applyTheme(v);
          toast(`Theme: ${v}`);
        });
      });

      // Typing dots toggle
      $("#toggleTypingDots").addEventListener("click", async ()=>{
        const v = !state.prefs.typingDots;
        await savePref("typingDots", v);
        $("#toggleTypingDots").textContent = v ? "On":"Off";
        toast(v ? "Typing dots on" : "Typing dots off");
      });

      // Export / wipe
      $("#btnExport").addEventListener("click", exportAll);
      $("#btnWipe").addEventListener("click", async ()=>{
        if(!confirm("Delete ALL local data? This cannot be undone.")) return;
        await DB.clearAll();
        location.reload();
      });

      // Install
      $("#btnInstall").addEventListener("click", async ()=>{
        if(!state.installPrompt) return;
        state.installPrompt.prompt();
        const res = await state.installPrompt.userChoice;
        toast(res.outcome==="accepted" ? "Installed" : "Install dismissed");
        state.installPrompt = null;
        $("#btnInstall").disabled = true;
      });

      window.addEventListener("beforeinstallprompt", (e)=>{
        e.preventDefault();
        state.installPrompt = e;
        $("#btnInstall").disabled = false;
      });

      // Close menu on escape
      window.addEventListener("keydown", (e)=>{
        if(e.key==="Escape"){
          closeMenu();
          closeViewer();
          closeOnboarding();
        }
      });
    }

    async function sendMessage(){
      const cid = state.activeChatId;
      if(!cid) return;
      const input = $("#msgInput");
      const text = (input.value||"").trim();
      if(!text) return;
      input.value = "";
      autoGrow(input);

      await addMessage(cid, "out", text, now());
      scrollThreadToBottom();

      const {suggestCouncil} = routerPick(cid, text);
      const reply = generateReply(cid, text);
      await simulateTypingThenReply(cid, reply);

      if(suggestCouncil){
        // gentle suggestion
        await addMessage(cid, "in", "If you want, I can bring the Council for 30 seconds. Tap Council üëÜ", now(), {tag: state.contacts.find(c=>c.id===cid)?.name || null, chips: makeChipsFor(cid)});
      }
    }

    // ---------------------------
    // Boot
    // ---------------------------
    async function boot(){
      setManifest();
      await registerSW();
      await DB.open();
      await loadPrefs();
      await loadReads();
      await ensureSeed();
      await loadAll();

      wireUI();
      renderChatList();
      updateBadges();

      // Default view
      setRoute("home");
      $("#emptyState").style.display = window.matchMedia("(min-width: 841px)").matches ? "flex" : "none";

      // First-run onboarding
      if(!state.prefs.onboarded){
        setTimeout(()=>openOnboarding(), 300);
      }else{
        // if primary contact exists, lightly keep it pinned
        const pc = state.prefs.primaryContact;
        if(pc && state.threads.get(pc)){
          const meta = state.threads.get(pc);
          if(meta && !meta.pinned){
            meta.pinned = true;
            await DB.put("threads", meta);
            state.threads.set(pc, meta);
          }
        }
      }
    }

    boot().catch(err=>{
      console.error(err);
      alert("App failed to start: " + (err?.message || err));
    });

  })();
  </script>
</body>
</html>
